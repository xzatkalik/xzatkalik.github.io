<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"><html><head><link type="text/css" rel="stylesheet" href="style1.css" media="screen" /><title>Tiny PXE Server</title></head><body><font> 
 
 
 
<p> 
<select ONCHANGE="location = this.options[this.selectedIndex].value;"> 
<option value="" disabled></option> 
<option value="../index.html">Contents</option> 
<option value="" disabled>=======</option> 
<option value="pxesrv_about.htm">Introduction</option> 
<option value="pxesrv_settings.htm">Settings</option> 
<option value="pxesrv_gui.htm">GUI Settings</option> 
<option value="pxesrv_config.htm">Config.ini settings</option> 
<option value="pxesrv_service.htm">Run as Service</option> 
<option value="firewall.htm">Firewall Settings</option> 
<option value="test_system.htm">Test System(s)</option> 
<option value="misc.htm">Miscellaneous</option> 
<option value="troubleshooting.htm">Troubleshooting</option> 
<option value="" disabled></option> 
<option value="" disabled>Boot Loaders</option> 
<option value="" disabled>==========</option> 
<option value="pxelinux.htm">PXELINUX</option> 
<option value="grub4dos.htm">Grub4Dos</option> 
<option value="ipxe.htm">iPXE</option> 
<option value="" disabled></option> 
<option value="" disabled>Boot</option> 
<option value="" disabled>====</option> 
<option value="fdd.htm">Floppy Disk Image</option> 
<option value="iso.htm">ISO Image</option> 
<option value="" disabled></option> 
<option value="" disabled>Linux</option> 
<option value="" disabled>=====</option> 
<option value="centos_netinstall.htm">CentOS - Network...</option> 
<option value="debian_netinstall.htm">Debian - Network...</option> 
<option value="fatdog.htm">FatDog</option> 
<option value="gparted.htm">GPartEd</option> 
<option value="ubuntu.htm">ubuntu/Lubuntu</option> 
<option value="ubuntu_netinstall.htm">ubuntu - Network...</option> 
<option value="" disabled></option> 
<option value="" disabled>WinPE</option> 
<option value="" disabled>=====</option> 
<option value="winpe.htm">WinPE</option> 
<option value="winpe_wimboot.htm">WinPE (wimboot)</option> 
<option value="winpe_bcd.htm">Multiple WinPE</option> 
<option value="" disabled></option> 
<option value="" disabled>Net Install Windows</option> 
<option value="" disabled>===============</option> 
<option value="ris.htm">RIS</option> 
<option value="ris_issues.htm">Troubleshooting RIS</option> 
<option value="win6x.htm">Install Windows NT 6.*</option> 
<option value="win5x.htm">Install Windows NT 5.*</option> 
<option value="" disabled></option> 
<option value="" disabled>SANBOOT (AoE)</option> 
<option value="" disabled>================</option> 
<option value="aoe_target.htm">AoE (Windows T...</option> 
<option value="aoe_install_winnt5.htm">AoE (Install Driver...</option> 
<option value="aoe_install_winnt6.htm">AoE (Install Driver...</option> 
<option value="aoe.htm">AoE (Clone...</option> 
<option value="" disabled></option> 
<option value="" disabled>SANBOOT (iSCSI)</option> 
<option value="" disabled>================</option> 
<option value="iscsi_targets.htm">iSCSI (Windows T...</option> 
<option value="iscsi_kernsafe.htm">iSCSI (Kernsafe...</option> 
<option value="iscsi_ms.htm">iSCSI (Microsoft...</option> 
<option value="iscsi_pytarget.htm">iSCSI (pyTarget)</option> 
<option value="iscsi.htm">iSCSI (Clone...</option> 
<option value="iscsi_install.htm">iSCSI (Install...</option> 
<option value="iscsi_centos.htm">iSCSI ...CentOS</option> 
<option value="iscsi_ubuntu.htm">iSCSI ...ubuntu</option> 
<option value="iscsi_ubuntu_netinstall.htm">iSCSI ...ubuntu (2)</option> 
<option value="" disabled></option> 
<option value="" disabled>Miscellaneous</option> 
<option value="" disabled>===========</option> 
<option value="clone.htm">Capture Windows...</option> 
<option value="clone_strarc.htm" selected="selected">Copy Windows...</option> 
<option value="service.htm">Network Adapter C...</option> 
<option value="wfplwf.htm">Unbinding The Light...</option> 
<option value="forensics.htm">Digital Forensic Acq...</option> 
<option value="ipxe_build.htm">iPXE - How to...</option> 
<option value="" disabled></option> 
<option value="" disabled>Appendices</option> 
<option value="" disabled>=========</option> 
<option value="pxesrv_zip.htm">Contents of pxesrv.zip</option> 
<option value="pxesrv_faq.htm">Erwan's FAQ</option> 
<option value="ack.htm">Acknowledgements...</option> 
<option value="" disabled></option> 
</select> 
</p> 
 
 
 
<hr> 
<img src="img/logo6.jpg" BORDER=1></a> 
 

 
 

<h2 align="center"><u>Copy Windows (STRARC)</u></h2>

<p>
<b><u><font color="red">NOTE</font></u></b> - <B><u>THIS PAGE FORMS PART OF THE INSTRUCTIONS FOR SETTING UP WINDOWS TO BOOT FROM A STORAGE AREA NETWORK (SAN) USING EITHER THE AoE OR iSCSI PROTOCOLS</B></u>.
</p>

<p>
This page covers a file copy method to clone an existing Windows installation on the <font class="file">Client</font> system to a disk image hosted on a <font class="file">Server</font> - utilising <a class="glossary" target="_blank" href="http://www.ltr-data.se/opencode.html/#CmdUtils">STRARC</a>. 
</p>

<p>
Assuming that the source (the <font class="file">Client</font> system) has already been configured for Network Booting, the instructions apply to iSCSI and/or AoE.
</p>


<p>
A range of methods can be used to clone Windows - including DD (which is covered on the <a class="glossary" target="_blank" href="http://www.etherboot.org/wiki/sanboot">etherboot</a> wiki pages). Traditional cloning methods will produce an exact copy of the source - a sector by sector copy. This may well require significant storage space on the server - depending on the size of the source disk. Another disadvantage of traditional cloning methods is the risk of disk signature collision (see <a class="glossary" target="_blank" href="https://blogs.technet.microsoft.com/markrussinovich/2011/11/06/fixing-disk-signature-collisions/">here</a>) - no two disks (including disk images) can be mounted on the same Windows NT system if they share the same disk signature. Using file based backups and copying to a new VHD image will mitigate against disk signature collision. 
</p>


<p>
Using file based backups and copying to a VHD <u><i>can</i></u> have the following advantages over traditional cloning methods -
<ul>
<li>Speed. Only files are copied - any content not in the file system table is skipped. </li>
</ul>
<ul>
<li>Reduced footprint. Files can be copied to a smaller (than original source) disk image providing that it contains enough space for the file content. </li>
</ul>
<ul>
<li>Mitigates against disk signature collision. </li>
</ul>
<ul>
<li>The disk on the <font class="file">Client</font> system does not need to be removed - this often needs to done when disks are cloned to avoid disk signature collision.</li>
</ul>
<ul>
<li>The <font class="file">Client</font> system can still be booted as required as its internal disk does not need to be removed.</li>
</ul>
</p>

<p>
<b><u><font color="red">NOTE</font></u></b> - all of the steps in this section should be completed in WinPE - <b><u>not</u></b> the <font class="file">Client</font> Operating System.
</p>


<p>
Page contents -
<ul>
<li><a class="glossary" href="clone_strarc.htm#required">Requirements</a></li>
<li><a class="glossary" href="clone_strarc.htm#paths">Paths</a></li>
<li><a class="glossary" href="clone_strarc.htm#prep1">Preparation (Boot Files)</a></li>
<li><a class="glossary" href="clone_strarc.htm#prep2">Preparation (Copy Windows Files)</a></li>
<li><a class="glossary" href="clone_strarc.htm#prep3">Preparation (MountedDevices)</a></li>
<li><a class="glossary" href="clone_strarc.htm#prep4">Preparation (Pagefile)</a> - optional</li>
</ul>
</p>




<a name="required"></a>
<h3 class="breaktop"><u>Requirements</u></h3>

<p>
<ul>
<li><font class="file">Client</font> - <font class="file">Client</font> System configured for AoE/iSCSI booting.</li>
</ul>
<ul>
<li><font class="file">Windows Preinstallation Environment (WinPE)</font> - WinPE 3.0 (or newer) is required for capturing the offline Windows Installation on the client system. WinPE can be PXE booted (see <a class="glossary" href="winpe.htm">here</a>).</li>
</ul>
<ul>
<li><font class="file">STRARC</font> - <i>"...A console backup/archive tool for all versions of Windows NT from NT 3.51 up to Windows 10. ...."</i> - see <a class="glossary" target="_blank" href="http://www.ltr-data.se/opencode.html/#CmdUtils">here</a> for more information and to download.</li>
</ul>
</p>





<a name="paths"></a>
<h3 class="breaktop"><u>Paths</u></h3>

<p>
The following file paths are used in this section (amend as required for your own setup) -
<ul>
<li><font class="file">C:\</font> - volume containing the <font class="file">Client</font> Operating System configured for Network Boot.</li>
<li><font class="file">Q:\</font> - mount point assigned to the <font class="file">Target</font>.</li>
<li><font class="file">D:\strarc.exe</font> - path to strarc executable.</li>
</ul>
</p>






<a name="prep1"></a>
<h3 class="breaktop"><u>Preparation (Boot Files)</u></h3>


<p>
<b><u>Windows NT 5.*</u></b>
</p>

<p>
If your <font class="file">Client</font> Operating System files are on the same volume as its boot files, then no action needs to be taken. If the boot files are located elsewhere, then they will need to be copied to <font class="file">C:\</font> before the image is captured. Required files are <font class="file">ntldr</font>, <font class="file">ntdetect.com</font> and <font class="file">boot.ini</font>
</p>


<p>
<b><u>Windows NT 6.*</u></b>
</p>

<p>
As we will be running the <font class="file">bcdboot</font> command at a later stage to create boot files on the <font class="file">Target</font> system, any <font class="file">\boot\</font> directory that might be present on the <font class="file">Client</font> is not required. Copying an existing <font class="file">\boot\</font> directory to the AoE or iSCSI <font class="file">Target</font> will result in multiple menu entries after running <font class="file">bcdboot</font> - this may result in booting the wrong system - the one on the <font class="file">Client</font> system's internal disk. <font class="file">STRARC</font> can be configured to exclude files and/or directories from being copied. 
</p>

















<a name="prep2"></a>
<h3 class="breaktop"><u>Preparation (Copy Windows Files)</u></h3>



<p>
Download <font class="file">STRARC</font> from the authors website (look in the <font class="file">Small command line utilities</font> section - <a class="glossary" target="_blank" href="http://www.ltr-data.se/opencode.html/#CmdUtils">here</a>). Be sure to download a version compatible with the processor architecture of the WinPE you will be using. 
</p>

<p>
Run the following command -
<ul>
<li><font class="file">D:\strarc.exe -c -j -d:C:\ -e:"pagefile.sys,System Volume Information,Boot" | D:\strarc.exe -xd:Q:\</font></li>
</ul>  
</p>



<p class="breaktop">
Splitting the above command into two parts - <font class="file">D:\strarc.exe -c -j -d:C:\ -e:"pagefile.sys,System Volume Information,Boot" | </font>
<ul>
<li><font class="file">D:\strarc.exe</font> - path to the <font class="file">D:\strarc.exe</font> executable.</li>
</ul>  
<ul>
<li><font class="file">-c</font> - switch to perform a backup\copy operation.</li>
</ul>  
<ul>
<li><font class="file">-j</font> - switch used to copy junctions or other reparse points. </li>
</ul>  
<ul>
<li><font class="file">-d</font> - switch used to specify the root directory for copy and restore operations. E.g. for copy operations, specifying <font class="file">-d:C:\</font> will copy the contents of the C:\ drive. </li>
</ul>  
<ul>
<li><font class="file">-e</font> - switch to exclude files and/or directories. E.g. specifying <font class="file">-e:"pagefile.sys,System Volume Information,Boot"</font> will exclude the following from the backup operation - </li>
	<ul>
	<li><font class="file">pagefile.sys</font></li>
	<li><font class="file">System Volume Information</font></li>
	<li><font class="file">Boot</font></li>
	</ul>
</ul>  
<ul>
<li><font class="file">|</font> - pipe the copy command from stdout to the command(s) following the separator. In the example on this page this is used to copy a complete directory tree from one NTFS volume to another.</li>
</ul> 
</p>

<p class="breaktop">
And the second part of the command <font class="file">D:\strarc.exe -xd:Q:\</font> (remember the copy command was piped to stdout) -

<ul>
<li><font class="file">D:\strarc.exe</font> - path to the <font class="file">D:\strarc.exe</font> executable.</li>
</ul> 
<ul>
<li><font class="file">-x</font> - switch to complete a restore operation - in this case from stdout. </li>
</ul> 
<ul>
<li><font class="file">-d</font> - switch used to specify the root directory for copy and restore operations. E.g. for restore/extract operations, specifying <font class="file">-d:Q:\</font> will extract/restore (in this case from stdout) to the Q:\ drive. </li>  
</ul> 
</p>

<p class="breaktop">
<b><u><font color="red">NOTE</font></b> - Consider adding additional settings to exclude any other none required files or folders from the copying process. </u>
</p>



<p>
For the full range of supported commands, refer to <a class="glossary" target="_blank" href="http://www.ltr-data.se/files/strarc.txt">strarc.txt</a>.
</p>























<a name="prep3"></a>
<h3 class="breaktop"><u>Preparation (MountedDevices)</u></h3>


<p>
The <font class="file">MountedDevices</font> key stores drive letter allocations (mount points) for any existing volumes. If you want your iSCSI/AoE system to be mounted as volume <font class="file">C:\</font> when booted, then this key will need to be edited and any <font class="file">\DosDevices\C:</font> Value will need to be either renamed or deleted to avoid conflicts when the AoE or iSCSI <font class="file">Target</font> is booted.  
</p>


<p>
Run the following command in WinPE to mount the <font class="file">system</font> registry hive from drive <font class="file">Q:</font> (the volume to which we have just copied the operating system files) -
<ul>
<li><font class="file">reg load HKLM\_SYSTEM Q:\windows\system32\config\system</font></li>
</ul>
</p>



<p>
The following screenshot shows the entries in the MountedDevices key (this is the <font class="file">Client</font> systems registry hive mounted Offline in WinPE - note the path <font class="file">HKLM\_SYSTEM\MountedDevices</font>) - 
<br />
<img src="img/mounteddevices1.jpg" border=1>
</p>


<p>
The <font class="file">\DosDevices\C:</font> entry in the panel on the right specifies the mount point for the Partition identified in its Data entry (the first four byte pairs (highlighted) are the hard disk signature, followed by offset (LBA)).
</p>

<p>
Delete any entries using the <font class="file">\DosDevices\#:</font> format to force Windows to reallocate drive letters/mount points. 
</p>

<p>
Alternatively, rename any entries using the <font class="file">\DosDevices\#:</font> format to manually allocate mount points. Renaming <font class="file">\DosDevices\C:</font> to <font class="file">\DosDevices\R:</font> for example will change the mount point for this partition to <font class="file">R:\</font> when Windows is booted. 
</p>



<p>
In the screenshot below you can see that <font class="file">\DosDevices\C:</font> (disk 0, partition 2) has been renamed to <font class="file">\DosDevices\R:</font> and <font class="file">\DosDevices\D:</font> (disk 0, Partition 3) has been renamed to <font class="file">\DosDevices\S:</font>... 
<br />
<img src="img/mounteddevices2.jpg" border=1>
</p>


<p>
...when this system is copied to and booted from an AoE or iSCSI <font class="file">Target</font>, the <font class="file">Client</font> systems disk 0 partition 2 will be mounted as <font class="file">R:</font> and disk 0 partition 3 will be mounted as <font class="file">S:</font>. The AoE/iSCSI <font class="file">Target</font> (a VHD containing one partition entry) will be mounted as <font class="file">C:</font> as this drive letter is now available.
</p>


<p>
After editing the <font class="file">MountedDevices</font> key, run the following command to unmount the registry hive -
<ul>
<li><font class="file">reg unload HKLM\_SYSTEM</font></li>
</ul>
</p>






<a name="prep4"></a>
<h3 class="breaktop"><u>Preparation (Pagefile)</u></h3>

<p>
<b><u><font color="red">This step is optional</font></u></b>. As we might be copying Windows to a VHD with less storage space than the original system, it is worth considering reducing the size of any pagefile.  
</p>

<p>
This can easily be done from WinPE by editing the offline registry. See below for commands syntax - 

<ul>
<li><font class="file">reg load HKLM\_SYSTEM Q:\windows\system32\config\system</font></li>
<li><font class="file">reg.exe add "HKLM\_SYSTEM\ControlSet001\Control\Session Manager\Memory Management" /v PagingFiles /t REG_MULTI_SZ /d "c:\pagefile.sys SIZE_MB MAX_SIZE_MB" /f
</font></li>
<li><font class="file">reg unload HKLM\_SYSTEM</font></li>
</ul>
</p>

<p>
These commands can be scripted. In the example below the pagefile is set to a fixed size of 1024 MB -
<br />
<textarea style="font-size:12px" cols="80" rows="6" align="left" wrap="OFF" readonly>
@echo off
reg load HKLM\_SYSTEM Q:\windows\system32\config\system
reg.exe add "HKLM\_SYSTEM\ControlSet001\Control\Session Manager\Memory Management" /v PagingFiles /t REG_MULTI_SZ /d "c:\pagefile.sys 1024 1024" /f
reg unload HKLM\_SYSTEM
</textarea>
</p>










<p class="breaktop"><font class="file">Document date - 28<sup>th</sup> February 2017(DRAFT)</font></p></font></body></html>