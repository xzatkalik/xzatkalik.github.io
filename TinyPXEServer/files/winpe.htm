<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"><html><head><link type="text/css" rel="stylesheet" href="style1.css" media="screen" /><title>Tiny PXE Server</title></head><body><font> 
 
 
 
<p> 
<select ONCHANGE="location = this.options[this.selectedIndex].value;"> 
<option value="" disabled></option> 
<option value="../index.html">Contents</option> 
<option value="" disabled>=======</option> 
<option value="pxesrv_about.htm">Introduction</option> 
<option value="pxesrv_settings.htm">Settings</option> 
<option value="pxesrv_gui.htm">GUI Settings</option> 
<option value="pxesrv_config.htm">Config.ini settings</option> 
<option value="pxesrv_service.htm">Run as Service</option> 
<option value="firewall.htm">Firewall Settings</option> 
<option value="test_system.htm">Test System(s)</option> 
<option value="misc.htm">Miscellaneous</option> 
<option value="troubleshooting.htm">Troubleshooting</option> 
<option value="" disabled></option> 
<option value="" disabled>Boot Loaders</option> 
<option value="" disabled>==========</option> 
<option value="pxelinux.htm">PXELINUX</option> 
<option value="grub4dos.htm">Grub4Dos</option> 
<option value="ipxe.htm">iPXE</option> 
<option value="" disabled></option> 
<option value="" disabled>Boot</option> 
<option value="" disabled>====</option> 
<option value="fdd.htm">Floppy Disk Image</option> 
<option value="iso.htm">ISO Image</option> 
<option value="" disabled></option> 
<option value="" disabled>Linux</option> 
<option value="" disabled>=====</option> 
<option value="centos_netinstall.htm">CentOS - Network...</option> 
<option value="debian_netinstall.htm">Debian - Network...</option> 
<option value="fatdog.htm">FatDog</option> 
<option value="gparted.htm">GPartEd</option> 
<option value="ubuntu.htm">ubuntu/Lubuntu</option> 
<option value="ubuntu_netinstall.htm">ubuntu - Network...</option> 
<option value="" disabled></option> 
<option value="" disabled>WinPE</option> 
<option value="" disabled>=====</option> 
<option value="winpe.htm" selected="selected">WinPE</option> 
<option value="winpe_wimboot.htm">WinPE (wimboot)</option> 
<option value="winpe_bcd.htm">Multiple WinPE</option> 
<option value="" disabled></option> 
<option value="" disabled>Net Install Windows</option> 
<option value="" disabled>===============</option> 
<option value="ris.htm">RIS</option> 
<option value="ris_issues.htm">Troubleshooting RIS</option> 
<option value="win6x.htm">Install Windows NT 6.*</option> 
<option value="win5x.htm">Install Windows NT 5.*</option> 
<option value="" disabled></option> 
<option value="" disabled>SANBOOT (AoE)</option> 
<option value="" disabled>================</option> 
<option value="aoe_target.htm">AoE (Windows T...</option> 
<option value="aoe_install_winnt5.htm">AoE (Install Driver...</option> 
<option value="aoe_install_winnt6.htm">AoE (Install Driver...</option> 
<option value="aoe.htm">AoE (Clone...</option> 
<option value="" disabled></option> 
<option value="" disabled>SANBOOT (iSCSI)</option> 
<option value="" disabled>================</option> 
<option value="iscsi_targets.htm">iSCSI (Windows T...</option> 
<option value="iscsi_kernsafe.htm">iSCSI (Kernsafe...</option> 
<option value="iscsi_ms.htm">iSCSI (Microsoft...</option> 
<option value="iscsi_pytarget.htm">iSCSI (pyTarget)</option> 
<option value="iscsi.htm">iSCSI (Clone...</option> 
<option value="iscsi_install.htm">iSCSI (Install...</option> 
<option value="iscsi_centos.htm">iSCSI ...CentOS</option> 
<option value="iscsi_ubuntu.htm">iSCSI ...ubuntu</option> 
<option value="iscsi_ubuntu_netinstall.htm">iSCSI ...ubuntu (2)</option> 
<option value="" disabled></option> 
<option value="" disabled>Miscellaneous</option> 
<option value="" disabled>===========</option> 
<option value="clone.htm">Capture Windows...</option> 
<option value="clone_strarc.htm">Copy Windows...</option> 
<option value="service.htm">Network Adapter C...</option> 
<option value="wfplwf.htm">Unbinding The Light...</option> 
<option value="forensics.htm">Digital Forensic Acq...</option> 
<option value="ipxe_build.htm">iPXE - How to...</option> 
<option value="" disabled></option> 
<option value="" disabled>Appendices</option> 
<option value="" disabled>=========</option> 
<option value="pxesrv_zip.htm">Contents of pxesrv.zip</option> 
<option value="pxesrv_faq.htm">Erwan's FAQ</option> 
<option value="ack.htm">Acknowledgements...</option> 
<option value="" disabled></option> 
</select> 
</p> 
 
 
 
<hr> 
<img src="img/logo6.jpg" BORDER=1></a> 
 



<h2 align="center"><u>WinPE</u></h2>




<p>
The Windows Preinstallation Environment (WinPE) is a lightweight version of Windows that can be used for many tasks. It was originally designed as a 32-bit replacement for DOS - for windows deployment, backup and recovery. WinPE is a complete, standalone operating system and will work independently of any other operating systems already installed. See <a target="_blank" href="http://technet.microsoft.com/en-us/library/cc766093(v=ws.10).aspx">here</a> for more information. 

<ul>
<li><a class="glossary" href="winpe.htm#files">Required Files</a></li>
<li><a class="glossary" href="winpe.htm#winpenbp">WinPE Network Bootstrap Program</a></li>
<li><a class="glossary" href="winpe.htm#pxelinux">pxelinux settings</a></li>
<li><a class="glossary" href="winpe.htm#grub4dos">grub4dos settings</a></li>
<li><a class="glossary" href="winpe.htm#ipxe">iPXE settings</a></li>
<li><a class="glossary" href="winpe.htm#ipxe_scripts">iPXE Scripts</a></li>
</ul>
</p>

<p>
This document covers PXE booting WinPE in RAM via a .wim file - the most common WinPE setup. Flat-boot WinPE is not covered. This page contains instructions for booting WinPE directly from a <font class="file">.wim</font> file - booting from a WinPE ISO file is covered elsewhere in this document (see <a class="glossary" href="iso.htm">here</a>). 
</p>


<p>
MistyPE screenshot (MistyPE is a winbuilder project - this particular build uses WinPE 3.1 source files) -<br />
<IMG SRC="img/winpe1.jpg" border=2>
</p>















<a name="files"></a>
<h3 class="breaktop"><u>Required Files</u></h3>



<p>
You will need to build your own WinPE as the files are Non-redistributable. Two simple methods include -
<ul>
<li><a target="_blank" href="http://reboot.pro/files/file/357-mistype/">
MistyPE</a> - winbuilder based build project that can be used to build WinPE from installation media and possibly from an existing Windows installation (depending on your setup).</li>
</ul>

<ul>
<li><a target="_blank" href="http://reboot.pro/files/file/340-quickpe/">QuickPE
</a> - From <b>erwan.l</b> (the author of <font class="file">Tiny PXE Server</font>). QuickPE is another minimalist WinPE that can also build from installation media or an existing Windows installation using a batch file.</li>
</ul>
</p>




<p>
The main WinPE files required for PXE Boot are -
<ul>
<li><font class="file">BCD</font></li>
<li><font class="file">*.sdi</font> (e.g. <font class="file">boot.sdi</font>)</li>
<li><font class="file">*.wim</font> (e.g. <font class="file">boot.wim</font>)</li>
<li><font class="file">bootmgr.exe</font> - extracted from <font class="file">*.wim</font></li>
<li><font class="file">pxeboot.n12</font> - extracted from <font class="file">*.wim</font></li>
</ul>
</p>



<p>
Various configurations can be used for PXE booting WinPE - the files listed above are the bare minimum used in testing. The location and name of the <font class="file">.wim</font> and <font class="file">.sdi</font> files are set in the Boot Configuration Data store (the <font class="file">BCD</font> file) - consequently names and paths can be changed. The path to the BCD store is hardcoded to <font class="file">\boot\BCD</font> (with this path being relative to the root directory of the TFTP server), however this can be changed by specifying a different path in <a class="glossary" href="pxesrv_config.htm#opt252">opt252</a> (in <font class="file">config.ini</font>). In the scope of this guide the following files and paths are used -
<ul>
<li><font class="file">\bootmgr.exe</font></li>
<li><font class="file">\pxeboot.0</font> (renamed <font class="file">pxeboot.n12</font>)</li>
<li><font class="file">\boot\BCD</font></li>
<li><font class="file">\boot\boot.sdi</font></li>
<li><font class="file">\boot\boot.wim</font></li>
</ul>
</p>



<p>
<font class="file">Tiny PXE Server</font> directory structure -
<ul>
<li><font class="file">C:\pxesrv\files\bootmgr.exe</font></li>
<li><font class="file">C:\pxesrv\files\pxeboot.0</font></li>
<li><font class="file">C:\pxesrv\files\boot\BCD</font></li>
<li><font class="file">C:\pxesrv\files\boot\boot.sdi</font></li>
<li><font class="file">C:\pxesrv\files\boot\boot.wim</font></li>
</ul>
</p>



<p>To obtain <font class="file">bootmgr.exe</font> and <font class="file">pxeboot.n12</font> you will need to extract them from <font class="file">boot.wim</font> - they can be located in the <font class="file">\Windows\Boot\PXE\</font> directory within the mounted .wim image. Various methods can be used to extract these files, including - 
<ul>
<li>DISM (see <a target="_blank" href="http://diddy.boot-land.net/pxe/files/winpe.htm">here</a> for instructions)</li>
<li>7-zip</li>
<li>wimlib-imagex (download from <a target="_blank" href="http://sourceforge.net/projects/wimlib/">here</a>)</li>
</ul>
Remember that <font class="file">pxeboot.0</font> is a (renamed) copy of <font class="file">pxeboot.n12</font>. A batch file to extract <font class="file">bootmgr.exe</font> and <font class="file">pxeboot.n12</font> using wimlib-imagex is available <a href="txt/wimlib_cmd.txt">here</a> (customise it to suit your own needs). 
</p>



<p>
Now add a menu entry for your preferred Network Bootstrap Program -
<ul>
<li><a class="glossary" href="winpe.htm#pxelinux">pxelinux settings</a></li>
<li><a class="glossary" href="winpe.htm#grub4dos">grub4dos settings</a></li>
<li><a class="glossary" href="winpe.htm#ipxe">iPXE settings</a></li>
<li><a class="glossary" href="winpe.htm#ipxe_scripts">iPXE Scripts</a></li>
</ul>
Or directly load the WinPE Network Bootstrap Program (see <a href="winpe.htm#winpenbp">here</a>)
</p>









<a name="winpenbp"></a>
<h3 class="breaktop"><u>WinPE Network Bootstrap Program</u></h3>

<p>
The WinPE network bootstrap program (<font class="file">pxeboot.0</font>) can be specified as the <font class="file">Tiny PXE Server</font> boot file (<a class="glossary" href="pxesrv_config.htm#filename">filename</a> option in <font class="file">config.ini</font>) - avoiding the need to chainload it from <font class="file">Grub4dos</font>/<font class="file">iPXE</font>/<font class="file">PXELINUX</font>. 
</p>


<p>
Click on one of the following for sample <font class="file">config.ini</font> settings (edit to reflect your own setup) -
<ul>
<li><b>DHCP</b> - <a href="txt/config_dhcp_pxeboot.txt">here</a></li>
<li><b>Proxy DHCP</b> - <a href="txt/config_proxydhcp_pxeboot.txt">here</a></li>
</ul>
</p>


<p>
To specify a path to the <font class="file">BCD</font> store other than the default <font class="file">/boot/BCD</font>, add an <a class="glossary" href="pxesrv_config.htm#opt252">opt252</a> entry (e.g. <font class="file">opt252=boot\x86\BCD</font>)
</p>




<p>
Screenshot (detail) of the WinPE <font class="file">boot.wim</font> file being loaded via TFTP during the PXE boot process -<br />
<IMG SRC="img/winpe2.jpg" border=2>
</p>














<a name="pxelinux"></a>
<h3 class="breaktop"><u>pxelinux settings</u></h3>


<p>
Remember to ensure that the required files are copied to your <font class="file">Tiny PXE Server</font> root directory - 
<ul>
<li><font class="file">C:\pxesrv\files\pxelinux.0</font></li>
<li><font class="file">C:\pxesrv\files\menu.c32</font></li> 
<li><font class="file">C:\pxesrv\files\pxelinux.cfg\default</font></li>
</ul>
</p>


<p>
Add the following to <font class="file">C:\pxesrv\files\pxelinux.cfg\default</font> (create this file if required) -
<br />
<textarea style="font-size:12px" cols="80" rows="10" align="left" wrap="OFF" readonly>

label winpe1
MENU LABEL WinPE (pxeboot.0)
KERNEL pxeboot.0
</textarea>
</p>


<p>
Click on one of the following for sample <font class="file">config.ini</font> settings (edit to reflect your own setup) -
<ul>
<li><b>DHCP</b> - <a href="txt/config_dhcp_pxelinux1.txt">here</a></li>
<li><b>Proxy DHCP</b> - <a href="txt/config_proxydhcp_pxelinux1.txt">here</a></li>
</ul>
</p>



<p>
To specify a path to the <font class="file">BCD</font> store other than the default <font class="file">/boot/BCD</font>, add an <a class="glossary" href="pxesrv_config.htm#opt252">opt252</a> entry (e.g. <font class="file">opt252=boot\x86\BCD</font>)
</p>











<a name="grub4dos"></a>
<h3 class="breaktop"><u>grub4dos settings</u></h3>


<p>
Remember to ensure that the required files are copied to your <font class="file">Tiny PXE Server</font> root directory - 
<ul>
<li><font class="file">C:\pxesrv\files\grldr</font></li>
<li><font class="file">C:\pxesrv\files\menu.lst\default</font></li>
</ul>
</p>


<p>
Add the following to <font class="file">C:\pxesrv\files\menu.lst\default</font> (create this file if required) -
<br />
<textarea style="font-size:12px" cols="80" rows="10" align=left wrap=off readonly>

title WinPE (pxeboot.0)
pxe keep
chainloader --raw (pd)/pxeboot.0 
</textarea>
</p>



<p>
Click on one of the following for <font class="file">config.ini</font> settings (edit to reflect your own setup) -
<ul>
<li><b>DHCP</b> - <a href="txt/config_dhcp_grldr1.txt">here</a></li>
<li><b>Proxy DHCP</b> - <a href="txt/config_proxydhcp_grldr1.txt">here</a></li>
</ul>
</p>


<p>
To specify a path to the <font class="file">BCD</font> store other than the default <font class="file">/boot/BCD</font>, add an <a class="glossary" href="pxesrv_config.htm#opt252">opt252</a> entry (e.g. <font class="file">opt252=boot\x86\BCD</font>)
</p>












<a name="ipxe"></a>
<h3 class="breaktop"><u>iPXE settings</u></h3>



<p>
Remember to ensure that the required files are copied to your <font class="file">Tiny PXE Server</font> root directory - 
<ul>
<li><font class="file">C:\pxesrv\files\ipxe.pxe</font> (or <font class="file">C:\pxesrv\files\ipxe-undionly.kpxe</font>)</li>
<li><font class="file">C:\pxesrv\files\ipxe_menu.txt</font></li> 
</ul>
</p>


<p>
Add the following to the menu section of <font class="file">C:\pxesrv\files\ipxe_menu.txt</font> (create this file if required) -
<br />
<textarea style="font-size:12px" cols="80" rows="10" align=left wrap=off readonly>
item winpe1        WinPE (pxeboot.0)
</textarea>
</p>



<p>
Add the following to the menu options section of <font class="file">C:\pxesrv\files\ipxe_menu.txt</font> -
<br />
<textarea style="font-size:12px" cols="80" rows="10" align=left wrap=off readonly>
:winpe1
chain ${boot-url}/pxeboot.0
</textarea>
</p>



<p>
E.g. - 
<br />
<textarea style="font-size:12px" cols="80" rows="10" align=left wrap=off readonly>
#!ipxe
#============== Set Variables ===============
set boot-url http://${dhcp-server}

#================ Main Menu =================
menu iPXE boot menu
item winpe1        WinPE (pxeboot.0)
choose target && goto ${target}

#============ Main Menu Options =============
:winpe1
chain ${boot-url}/pxeboot.0

</textarea>
<br />
<b>NOTE</b> - remember to change <font class="file">set boot-url http://${dhcp-server}</font> if using ProxyDHCP.
</p>




<p>
Click on one of the following for <font class="file">config.ini</font> settings (edit to reflect your own setup) -
<ul>
<li><b>DHCP</b> - <a href="txt/config_dhcp_ipxe1.txt">here</a></li>
<li><b>Proxy DHCP</b> - <a href="txt/config_proxydhcp_ipxe1.txt">here</a></li>
</ul>
</p>


<p>
To specify a path to the <font class="file">BCD</font> store other than the default <font class="file">/boot/BCD</font>, add an <a class="glossary" href="pxesrv_config.htm#opt252">opt252</a> entry (e.g. <font class="file">opt252=boot\x86\BCD</font>)
</p>








<a name="ipxe_scripts"></a>
<h3 class="breaktop"><u>iPXE Scripts</u></h3>


<p>
<font class="file">iPXE</font> menus are essentially complicated scripts. It's also possible to specify a script using the <a class="glossary" href="pxesrv_config.htm#altfilename">altfilename</a> option in <font class="file">config.ini</font>. <b>NOTE</b> - remember to change <font class="file">set boot-url http://${dhcp-server}</font> if using ProxyDHCP.
</p>



<p>
Sample <font class="file">iPXE</font> script - <br />
<textarea style="font-size:12px" cols="80" rows="10" align=left wrap=off readonly>

#!ipxe
set boot-url http://${dhcp-server}
chain ${boot-url}/pxeboot.0
</textarea>
</p>






<p class="breakbottom">
</p>







<p class="breaktop"><font class="file">Document date - 28<sup>th</sup> February 2017(DRAFT)</font></p></font></body></html>